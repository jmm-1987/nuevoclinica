<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cl√≠nica Dental - Chatbot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --light-color: #f8fafc;
            --dark-color: #1e293b;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            width: 100%;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 0;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        .chat-wrapper {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .chat-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            height: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .chat-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .chat-header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8fafc;
        }

        .message {
            margin-bottom: 20px;
            animation: fadeInUp 0.3s ease-out;
        }

        .message.bot {
            text-align: left;
        }

        .message.user {
            text-align: right;
        }

        .message-content {
            display: inline-block;
            max-width: 80%;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            position: relative;
        }

        .message.bot .message-content {
            background: white;
            color: var(--dark-color);
            box-shadow: var(--shadow);
            border-bottom-left-radius: 5px;
        }

        .message.user .message-content {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .message-text {
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .chat-options {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .option-button {
            background: white;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .option-button:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(37, 99, 235, 0.3);
        }

        .option-button:active {
            transform: translateY(0);
        }

        .option-icon {
            font-size: 1.2rem;
        }

        .detail-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 15px;
            box-shadow: var(--shadow);
        }

        .detail-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .detail-label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .detail-value {
            color: var(--dark-color);
            line-height: 1.5;
        }

        .images-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .image-item {
            text-align: center;
        }

        .image-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .image-label {
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 8px;
            font-size: 0.9rem;
        }

        .form-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 15px;
            box-shadow: var(--shadow);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--dark-color);
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
        }

        .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .success-message {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 15px;
            box-shadow: var(--shadow);
        }

        .error-message {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 15px;
            box-shadow: var(--shadow);
        }

        .ubicacion-item {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }

        .ubicacion-item h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .ubicacion-item p {
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        .financiacion-content h4 {
            color: var(--primary-color);
            margin: 20px 0 10px 0;
        }

        .financiacion-content ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .financiacion-content li {
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 15px 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .chat-input-field {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
        }

        .chat-input-field:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .send-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-button:hover {
            background: var(--secondary-color);
        }

        /* Estilos para el calendario */
        .calendar-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 15px;
            box-shadow: var(--shadow);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-title {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calendar-nav-btn:hover {
            background: var(--secondary-color);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: var(--primary-color);
            padding: 10px 5px;
            font-size: 0.9rem;
        }

        .calendar-day {
            text-align: center;
            padding: 12px 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .calendar-day:hover {
            background: rgba(37, 99, 235, 0.1);
        }

        .calendar-day.available {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .calendar-day.available:hover {
            background: var(--success-color);
            color: white;
        }

        .calendar-day.selected {
            background: var(--primary-color);
            color: white;
        }

        .calendar-day.disabled {
            color: #cbd5e1;
            cursor: not-allowed;
        }

        .calendar-day.today {
            border: 2px solid var(--primary-color);
        }

        /* Estilos para el selector de horas */
        .time-selector {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 15px;
            box-shadow: var(--shadow);
        }

        .time-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .time-slot {
            background: white;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 12px 8px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: center;
            font-size: 0.9rem;
        }

        .time-slot:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .time-slot.selected {
            background: var(--primary-color);
            color: white;
        }

        .time-slot.available {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .time-slot.available:hover {
            background: var(--success-color);
            color: white;
        }

        .time-slot.disabled {
            background: #f1f5f9;
            color: #cbd5e1;
            border-color: #e2e8f0;
            cursor: not-allowed;
        }

        .time-slot.occupied {
            background: #fef2f2;
            color: #dc2626;
            border-color: #fecaca;
            cursor: not-allowed;
            position: relative;
        }

        .time-slot.occupied::after {
            content: "‚ùå";
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.8rem;
        }

        /* Estilos para la confirmaci√≥n de cita */
        .confirmation-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 15px;
            box-shadow: var(--shadow);
        }

        .confirmation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .confirmation-item:last-child {
            border-bottom: none;
        }

        .confirmation-label {
            font-weight: 600;
            color: var(--primary-color);
        }

        .confirmation-value {
            color: var(--dark-color);
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
                width: 100vw;
                overflow-x: hidden;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .chat-wrapper {
                width: 100%;
                max-width: 100%;
                margin: 0 auto;
            }
            
            .chat-container {
                height: 100vh;
                max-width: 100%;
                border-radius: 0;
                width: 100%;
            }
            
            .chat-header {
                border-radius: 0;
            }

            .images-container {
                grid-template-columns: 1fr;
            }

            .calendar-grid {
                gap: 3px;
            }

            .calendar-day {
                padding: 8px 3px;
                font-size: 0.8rem;
            }

            .time-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="chat-wrapper">
        <div class="chat-container">
            <div class="chat-header">
                <h1>ü¶∑ Cl√≠nica Dental</h1>
                <p>Asistente Virtual</p>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <!-- Los mensajes se cargar√°n din√°micamente -->
            </div>
            
            <div class="chat-input">
                <div class="input-group">
                    <input type="text" class="chat-input-field" id="userInput" placeholder="Escribe tu mensaje..." style="display: none;">
                    <button class="send-button" id="sendButton" style="display: none;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class Chatbot {
            constructor() {
                this.chatMessages = document.getElementById('chatMessages');
                this.userInput = document.getElementById('userInput');
                this.sendButton = document.getElementById('sendButton');
                this.currentState = {};
                
                this.init();
            }
            
            init() {
                this.showTypingIndicator();
                setTimeout(() => {
                    this.loadMenuPrincipal();
                }, 1000);
            }
            
            showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message bot typing-indicator';
                typingDiv.innerHTML = `
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                `;
                this.chatMessages.appendChild(typingDiv);
                this.scrollToBottom();
            }
            
            removeTypingIndicator() {
                const typingIndicator = this.chatMessages.querySelector('.typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
            
            clearChat() {
                this.chatMessages.innerHTML = '';
            }
            
            async loadMenuPrincipal() {
                this.removeTypingIndicator();
                const response = await this.sendChatRequest('menu_principal');
                this.displayMessage(response);
            }
            
            async sendChatRequest(action, value = null, additionalData = {}) {
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: action,
                            value: value,
                            ...additionalData
                        })
                    });
                    
                    if (!response.ok) {
                        console.error('Error del servidor:', response.status, response.statusText);
                        return {
                            type: 'error',
                            title: '‚ùå Error del servidor',
                            message: 'Ha ocurrido un error en el servidor. Por favor, int√©ntalo de nuevo.',
                            options: [
                                {'id': 'menu_principal', 'text': 'üè† Volver al men√∫ principal', 'icon': 'üè†'}
                            ]
                        };
                    }
                    
                    const data = await response.json();
                    
                    // Verificar si la respuesta tiene un error
                    if (data.error) {
                        return {
                            type: 'error',
                            title: '‚ùå Error',
                            message: data.error,
                            options: [
                                {'id': 'menu_principal', 'text': 'üè† Volver al men√∫ principal', 'icon': 'üè†'}
                            ]
                        };
                    }
                    
                    return data;
                } catch (error) {
                    console.error('Error:', error);
                    return {
                        type: 'error',
                        title: '‚ùå Error de conexi√≥n',
                        message: 'No se pudo conectar con el servidor. Por favor, verifica tu conexi√≥n e int√©ntalo de nuevo.',
                        options: [
                            {'id': 'menu_principal', 'text': 'üè† Volver al men√∫ principal', 'icon': 'üè†'}
                        ]
                    };
                }
            }
            
            displayMessage(data) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot';
                
                let content = `
                    <div class="message-content">
                        <div class="message-title">${data.title}</div>
                        <div class="message-text">${data.message}</div>
                `;
                
                if (data.type === 'detail') {
                    if (data.content.html) {
                        content += `<div class="detail-content">${data.content.html}</div>`;
                    } else {
                        content += this.renderDetailContent(data.content);
                    }
                } else if (data.type === 'form') {
                    content += this.renderForm(data);
                } else if (data.type === 'calendar') {
                    content += this.renderCalendar(data);
                } else if (data.type === 'time_selector') {
                    content += this.renderTimeSelector(data);
                } else if (data.type === 'confirmation') {
                    content += this.renderConfirmation(data);
                } else if (data.type === 'success') {
                    // El mensaje de √©xito puede contener HTML, as√≠ que lo insertamos directamente
                    const successMessage = data.message || 'Cita agendada con √©xito';
                    content += `<div class="success-message">${successMessage}</div>`;
                } else if (data.type === 'error') {
                    // Manejo espec√≠fico para errores
                    const errorMessage = data.message || 'Ha ocurrido un error';
                    content += `<div class="error-message">${errorMessage}</div>`;
                }
                
                if (data.options) {
                    content += this.renderOptions(data.options);
                }
                
                content += '</div>';
                messageDiv.innerHTML = content;
                
                this.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
                
                // Agregar event listeners a los botones y elementos interactivos
                this.addButtonListeners(messageDiv, data);
                this.addCalendarListeners(messageDiv, data);
                this.addTimeSelectorListeners(messageDiv, data);
            }
            
            renderDetailContent(content) {
                let html = '<div class="detail-content">';
                
                // Renderizar informaci√≥n b√°sica
                for (const [key, value] of Object.entries(content)) {
                    if (key !== 'imagen_antes' && key !== 'imagen_despues') {
                        const label = this.getLabel(key);
                        html += `
                            <div class="detail-item">
                                <div class="detail-label">${label}</div>
                                <div class="detail-value">${value}</div>
                            </div>
                        `;
                    }
                }
                
                // Renderizar im√°genes de antes y despu√©s si existen
                if (content.imagen_antes && content.imagen_despues) {
                    html += `
                        <div class="detail-item">
                            <div class="detail-label">üñºÔ∏è Antes y Despu√©s</div>
                            <div class="images-container">
                                <div class="image-item">
                                    <img src="${content.imagen_antes}" alt="Antes" onerror="this.style.display='none'">
                                    <div class="image-label">Antes</div>
                                </div>
                                <div class="image-item">
                                    <img src="${content.imagen_despues}" alt="Despu√©s" onerror="this.style.display='none'">
                                    <div class="image-label">Despu√©s</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                return html;
            }
            
            getLabel(key) {
                const labels = {
                    'descripcion': 'üìù Descripci√≥n',
                    'duracion': '‚è±Ô∏è Duraci√≥n',
                    'precio': 'üí∞ Precio',
                    'antes_despues': 'üîÑ Antes y Despu√©s',
                    'preguntas_frecuentes': '‚ùì Preguntas Frecuentes'
                };
                return labels[key] || key;
            }
            
            renderForm(data) {
                let html = '<div class="form-container">';
                html += '<form id="citaForm">';
                
                data.form_fields.forEach(field => {
                    if (field.type === 'textarea') {
                        html += `
                            <div class="form-group">
                                <label class="form-label">${field.label}</label>
                                <textarea id="${field.id}" 
                                          class="form-textarea" 
                                          ${field.required ? 'required' : ''}
                                          placeholder="Describe aqu√≠ el motivo de tu visita..."></textarea>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="form-group">
                                <label class="form-label">${field.label}</label>
                                <input type="${field.type}" 
                                       id="${field.id}" 
                                       class="form-input" 
                                       ${field.required ? 'required' : ''}>
                            </div>
                        `;
                    }
                });
                
                html += `
                    <button type="submit" class="option-button" style="margin-top: 15px; width: 100%;">
                        <span class="option-icon">üìÖ</span>
                        Continuar con la cita
                    </button>
                </form>
                </div>
                `;
                
                return html;
            }

            renderCalendar(data) {
                const today = new Date();
                
                // Determinar qu√© mes mostrar basado en las fechas disponibles
                let displayMonth = today.getMonth();
                let displayYear = today.getFullYear();
                
                if (data.available_dates && Array.isArray(data.available_dates) && data.available_dates.length > 0) {
                    // Tomar la primera fecha disponible para determinar el mes a mostrar
                    const firstAvailableDate = new Date(data.available_dates[0]);
                    displayMonth = firstAvailableDate.getMonth();
                    displayYear = firstAvailableDate.getFullYear();
                }
                
                console.log(`Mostrando calendario para: ${displayMonth}/${displayYear}`);

                
                let html = '<div class="calendar-container">';
                html += '<div class="calendar-header">';
                html += `<div class="calendar-title">${this.getMonthName(displayMonth)} ${displayYear}</div>`;
                html += '<div class="calendar-nav">';
                html += '<button class="calendar-nav-btn" id="prevMonth">‚Äπ</button>';
                html += '<button class="calendar-nav-btn" id="nextMonth">‚Ä∫</button>';
                html += '</div>';
                html += '</div>';
                
                html += '<div class="calendar-grid">';
                
                // D√≠as de la semana
                const daysOfWeek = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
                daysOfWeek.forEach(day => {
                    html += `<div class="calendar-day-header">${day}</div>`;
                });
                
                // Generar d√≠as del mes
                const firstDay = new Date(displayYear, displayMonth, 1);
                const lastDay = new Date(displayYear, displayMonth + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay() + 1);
                
                for (let i = 0; i < 42; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    
                    const isCurrentMonth = currentDate.getMonth() === displayMonth;
                    const isToday = currentDate.toDateString() === today.toDateString();
                    const isPast = currentDate < today;
                    
                    // Simplificar la l√≥gica de disponibilidad
                    let isAvailable = false;
                    if (data.available_dates && Array.isArray(data.available_dates) && data.available_dates.length > 0) {
                        const dateString = currentDate.toISOString().split('T')[0];
                        isAvailable = data.available_dates.includes(dateString);
                        if (isCurrentMonth && !isPast) {
                            console.log(`Fecha ${dateString}: ${isAvailable ? 'disponible' : 'no disponible'}`);
                        }
                    } else {
                        console.error('Error: available_dates no es v√°lido:', data.available_dates);
                        // Fallback: mostrar d√≠as futuros como disponibles
                        if (isCurrentMonth && !isPast) {
                            isAvailable = true;
                        }
                    }
                    
                    let classes = 'calendar-day';
                    if (!isCurrentMonth) {
                        classes += ' disabled';
                    } else if (isPast) {
                        classes += ' disabled';
                    } else if (isAvailable) {
                        classes += ' available';
                    } else {
                        classes += ' disabled';
                    }
                    
                    if (isToday) classes += ' today';
                    
                    html += `<div class="${classes}" data-date="${currentDate.toISOString().split('T')[0]}">${currentDate.getDate()}</div>`;
                }
                
                html += '</div>';
                html += '</div>';
                
                return html;
            }

            renderTimeSelector(data) {
                let html = '<div class="time-selector">';
                html += '<h4 style="color: var(--primary-color); margin-bottom: 15px;">üïê Selecciona una hora</h4>';
                
                // Definir todas las horas posibles
                const allTimes = [
                    '09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00',
                    '16:00', '16:30', '17:00', '17:30', '18:00', '18:30'
                ];
                
                html += '<div class="time-grid">';
                
                allTimes.forEach(time => {
                    const isOccupied = data.occupied_times && data.occupied_times.includes(time);
                    const isAvailable = data.available_times && data.available_times.includes(time);
                    
                    let classes = 'time-slot';
                    if (isOccupied) {
                        classes += ' occupied';
                    } else if (isAvailable) {
                        classes += ' available';
                    } else {
                        classes += ' disabled';
                    }
                    
                    html += `<div class="${classes}" data-time="${time}" ${isOccupied ? 'data-occupied="true"' : ''}>${time}</div>`;
                });
                
                html += '</div>';
                html += '</div>';
                
                return html;
            }

            renderConfirmation(data) {
                let html = '<div class="confirmation-container">';
                html += '<h4 style="color: var(--primary-color); margin-bottom: 15px;">‚úÖ Confirma tu cita</h4>';
                
                Object.entries(data.confirmation_data).forEach(([key, value]) => {
                    const label = this.getConfirmationLabel(key);
                    html += `
                        <div class="confirmation-item">
                            <span class="confirmation-label">${label}</span>
                            <span class="confirmation-value">${value}</span>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                return html;
            }

            getMonthName(month) {
                const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                return months[month];
            }



            getConfirmationLabel(key) {
                const labels = {
                    'nombre': 'üë§ Nombre',
                    'email': 'üìß Email',
                    'telefono': 'üìû Tel√©fono',
                    'motivo': 'üìù Motivo',
                    'fecha': 'üìÖ Fecha',
                    'hora': 'üïê Hora'
                };
                return labels[key] || key;
            }
            
            renderOptions(options) {
                let html = '<div class="chat-options">';
                options.forEach(option => {
                    html += `
                        <button class="option-button" data-action="${option.id}">
                            <span class="option-icon">${option.icon}</span>
                            ${option.text}
                        </button>
                    `;
                });
                html += '</div>';
                return html;
            }
            
            addButtonListeners(messageDiv, data) {
                const buttons = messageDiv.querySelectorAll('.option-button[data-action]');
                buttons.forEach(button => {
                    button.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const action = button.dataset.action;
                        console.log('Bot√≥n clickeado - action:', action, 'button:', button);
                        
                        if (!action) {
                            console.error('Error: El bot√≥n no tiene data-action definido');
                            return;
                        }
                        
                        try {
                            await this.handleButtonClick(action, data);
                        } catch (error) {
                            console.error('Error en handleButtonClick:', error);
                        }
                    });
                });
                
                // Manejar formularios
                const form = messageDiv.querySelector('#citaForm');
                if (form) {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        await this.handleFormSubmit(form, data);
                    });
                }
            }

            addCalendarListeners(messageDiv, data) {
                // Event listeners para d√≠as disponibles
                const calendarDays = messageDiv.querySelectorAll('.calendar-day.available');
                calendarDays.forEach(day => {
                    day.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const selectedDate = day.dataset.date;
                        
                        // Limpiar selecci√≥n anterior
                        messageDiv.querySelectorAll('.calendar-day').forEach(d => {
                            d.classList.remove('selected');
                        });
                        
                        // Marcar como seleccionado
                        day.classList.add('selected');
                        
                        // Guardar fecha en el estado
                        this.currentState.fecha = selectedDate;
                        
                        // Mostrar indicador de escritura
                        this.showTypingIndicator();
                        
                        setTimeout(async () => {
                            this.removeTypingIndicator();
                            const response = await this.sendChatRequest('seleccionar_hora', null, {
                                datos_paciente: this.currentState.datos_paciente,
                                motivo: this.currentState.motivo,
                                fecha: selectedDate
                            });
                            this.displayMessage(response);
                        }, 500);
                    });
                });
                
                // Event listeners para navegaci√≥n del calendario
                const prevMonthBtn = messageDiv.querySelector('#prevMonth');
                const nextMonthBtn = messageDiv.querySelector('#nextMonth');
                
                if (prevMonthBtn) {
                    prevMonthBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('Navegaci√≥n del calendario no implementada a√∫n');
                        // TODO: Implementar navegaci√≥n del calendario
                    });
                }
                
                if (nextMonthBtn) {
                    nextMonthBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('Navegaci√≥n del calendario no implementada a√∫n');
                        // TODO: Implementar navegaci√≥n del calendario
                    });
                }
            }

            addTimeSelectorListeners(messageDiv, data) {
                const timeSlots = messageDiv.querySelectorAll('.time-slot:not(.occupied):not(.disabled)');
                timeSlots.forEach(slot => {
                    slot.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const selectedTime = slot.dataset.time;
                        
                        // Limpiar selecci√≥n anterior
                        messageDiv.querySelectorAll('.time-slot').forEach(s => {
                            s.classList.remove('selected');
                        });
                        
                        // Marcar como seleccionado
                        slot.classList.add('selected');
                        
                        // Guardar hora en el estado
                        this.currentState.hora = selectedTime;
                        
                        // Mostrar indicador de escritura
                        this.showTypingIndicator();
                        
                        setTimeout(async () => {
                            this.removeTypingIndicator();
                            const response = await this.sendChatRequest('confirmar_cita', null, {
                                datos_paciente: this.currentState.datos_paciente,
                                motivo: this.currentState.motivo,
                                fecha: this.currentState.fecha,
                                hora: selectedTime
                            });
                            this.displayMessage(response);
                        }, 500);
                    });
                });
            }
            
            async handleButtonClick(action, data) {
                console.log('handleButtonClick llamado con action:', action, 'data:', data);
                
                if (!action || typeof action !== 'string') {
                    console.error('Error: action es undefined o no es una cadena en handleButtonClick:', action);
                    return;
                }
                
                // Limpiar chat inmediatamente
                this.clearChat();
                
                // Mostrar indicador de escritura
                this.showTypingIndicator();
                
                let response;
                
                if (action === 'tratamientos') {
                    response = await this.sendChatRequest('tratamientos');
                } else if (action && action.startsWith('tratamiento_')) {
                    response = await this.sendChatRequest('tratamiento_detalle', action);
                } else if (action === 'agendar') {
                    response = await this.sendChatRequest('agendar');
                } else if (action === 'revision_periodica') {
                    response = await this.sendChatRequest('revision_periodica');
                } else if (action === 'otros_motivos') {
                    response = await this.sendChatRequest('otros_motivos');
                } else if (action === 'ubicaciones') {
                    response = await this.sendChatRequest('ubicaciones');
                } else if (action === 'financiacion') {
                    response = await this.sendChatRequest('financiacion');
                } else if (action === 'volver' || action === 'volver_tratamientos' || action === 'volver_agendar' || action === 'volver_datos' || action === 'volver_fecha') {
                    // Volver al men√∫ principal
                    setTimeout(() => {
                        this.loadMenuPrincipal();
                    }, 500);
                    return;
                } else if (action && action.startsWith('fecha_')) {
                    const fecha = action.split('_')[1];
                    response = await this.sendChatRequest('seleccionar_hora', null, {
                        datos_paciente: this.currentState.datos_paciente,
                        motivo: this.currentState.motivo,
                        fecha: fecha
                    });
                } else if (action === 'guardar_cita') {
                    response = await this.sendChatRequest('guardar_cita', null, {
                        datos_paciente: this.currentState.datos_paciente,
                        motivo: this.currentState.motivo,
                        fecha: this.currentState.fecha,
                        hora: this.currentState.hora
                    });
                } else if (action === 'volver_hora') {
                    response = await this.sendChatRequest('seleccionar_hora', null, {
                        datos_paciente: this.currentState.datos_paciente,
                        motivo: this.currentState.motivo,
                        fecha: this.currentState.fecha
                    });
                } else if (action === 'menu_principal') {
                    setTimeout(() => {
                        this.loadMenuPrincipal();
                    }, 500);
                    return;
                } else {
                    console.error('Action no reconocida:', action);
                    return;
                }
                
                setTimeout(() => {
                    this.removeTypingIndicator();
                    if (response) {
                        this.displayMessage(response);
                    }
                }, 1000);
            }
            
            async handleFormSubmit(form, data) {
                console.log('Formulario enviado');
                const formData = new FormData(form);
                const datosPaciente = {};
                
                data.form_fields.forEach(field => {
                    const element = document.getElementById(field.id);
                    datosPaciente[field.id] = element.value;
                });
                
                console.log('Datos del paciente:', datosPaciente);
                
                // Validar datos
                for (const field of data.form_fields) {
                    if (field.required && !datosPaciente[field.id]) {
                        alert('Por favor, completa todos los campos obligatorios.');
                        return;
                    }
                }
                
                // Guardar datos en el estado actual
                this.currentState.datos_paciente = datosPaciente;
                this.currentState.motivo = data.motivo;
                
                console.log('Estado actual:', this.currentState);
                
                // Limpiar chat inmediatamente
                this.clearChat();
                
                // Mostrar indicador de escritura
                this.showTypingIndicator();
                
                try {
                    // Enviar la solicitud inmediatamente sin setTimeout
                    const response = await this.sendChatRequest('seleccionar_fecha', null, {
                        datos_paciente: datosPaciente,
                        motivo: data.motivo
                    });
                    
                    console.log('Respuesta del servidor:', response);
                    
                    this.removeTypingIndicator();
                    this.displayMessage(response);
                } catch (error) {
                    console.error('Error al enviar la solicitud:', error);
                    this.removeTypingIndicator();
                    alert('Error al procesar la solicitud. Por favor, intenta de nuevo.');
                }
            }
            
            scrollToBottom() {
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }
        }
        
        // Inicializar el chatbot cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            new Chatbot();
        });
    </script>
</body>
</html> 